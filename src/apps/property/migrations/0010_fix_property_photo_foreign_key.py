
# Generated by Django 4.2.7 on 2024-01-15 10:00

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ('property', '0008_add_slug_field_safely'),
    ]

    operations = [
        # Verificar si la tabla ya existe antes de hacer cambios
        migrations.RunSQL(
            """
            SET @table_exists = (
                SELECT COUNT(*) 
                FROM information_schema.TABLES 
                WHERE TABLE_SCHEMA = DATABASE() 
                AND TABLE_NAME = 'property_propertyphoto'
            );
            """,
            reverse_sql="-- No reverse needed"
        ),
        
        # Solo ejecutar si la tabla existe
        migrations.RunSQL(
            """
            SET @sql = IF(@table_exists > 0,
                'SELECT "Table exists, proceeding with FK fixes" as info',
                'SELECT "Table does not exist, skipping FK fixes" as info'
            );
            PREPARE stmt FROM @sql;
            EXECUTE stmt;
            DEALLOCATE PREPARE stmt;
            """,
            reverse_sql="-- No reverse needed"
        ),
        
        # Eliminar constraint existente solo si la tabla existe
        migrations.RunSQL(
            """
            SET @sql = IF(@table_exists > 0,
                CONCAT('ALTER TABLE property_propertyphoto DROP FOREIGN KEY ', 
                    IFNULL((SELECT CONSTRAINT_NAME 
                           FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE 
                           WHERE TABLE_SCHEMA = DATABASE() 
                           AND TABLE_NAME = "property_propertyphoto" 
                           AND COLUMN_NAME = "property_id" 
                           AND CONSTRAINT_NAME != "PRIMARY"
                           LIMIT 1), 'dummy_constraint')),
                'SELECT "No table to modify" as info'
            );
            
            -- Solo ejecutar si encontramos un constraint real
            IF (@sql LIKE 'ALTER TABLE%' AND @sql NOT LIKE '%dummy_constraint%') THEN
                PREPARE stmt FROM @sql;
                EXECUTE stmt;
                DEALLOCATE PREPARE stmt;
            END IF;
            """,
            reverse_sql="-- No reverse needed"
        ),
        
        # Modificar el tipo de columna solo si la tabla existe
        migrations.RunSQL(
            """
            IF @table_exists > 0 THEN
                ALTER TABLE property_propertyphoto MODIFY COLUMN property_id CHAR(32) NOT NULL;
            END IF;
            """,
            reverse_sql="""
            IF @table_exists > 0 THEN
                ALTER TABLE property_propertyphoto MODIFY COLUMN property_id INT NOT NULL;
            END IF;
            """
        ),
        
        # Agregar nuevo constraint solo si la tabla existe
        migrations.RunSQL(
            """
            IF @table_exists > 0 THEN
                ALTER TABLE property_propertyphoto 
                ADD CONSTRAINT property_propertyphoto_property_id_fk 
                FOREIGN KEY (property_id) REFERENCES property_property (id) ON DELETE CASCADE;
            END IF;
            """,
            reverse_sql="""
            IF @table_exists > 0 THEN
                ALTER TABLE property_propertyphoto DROP FOREIGN KEY property_propertyphoto_property_id_fk;
            END IF;
            """
        ),
    ]
